# Template file for 'opensnitch'
pkgname=opensnitch
version=1.3.6
revision=1
build_wrksrc="daemon"
build_style=go
go_import_path="github.com/evilsocket/opensnitch/daemon"
go_package="${go_import_path}"
go_mod_mode="mod"
hostmakedepends="pkg-config python3-setuptools"
makedepends="libnetfilter_queue-devel python3-devel"
depends="python3-grpcio-tools python3-slugify python3-inotify
 python3-PyQt5 python3-PyQt5-sql qt5-wayland qt5-plugin-sqlite"
conf_files="/etc/opensnitchd/default-config.json
 /etc/opensnitchd/system-fw.json"
make_dirs="/etc/opensnitchd/rules/ 0755 root root
 /etc/opensnitchd/ 0755 root root"
short_desc="GNU/Linux port of the Little Snitch application firewall"
maintainer="Anubhav Kini <anubhavkini@gmail.com>"
license="GPL-3.0-only"
homepage="https://github.com/evilsocket/opensnitch"
distfiles="${homepage}/archive/refs/tags/v${version}.tar.gz"
checksum=a02e49a5ed79db8f21788188f16a28684d5f54f583bb4d338e3386484ee1663a

_py() {
	cd ../ui
	if [ -n "$CROSS_BUILD" ]; then
		PYPREFIX="$XBPS_CROSS_BASE"
		CFLAGS+=" -I${XBPS_CROSS_BASE}/${py3_inc} -I${XBPS_CROSS_BASE}/usr/include"
		LDFLAGS+=" -L${XBPS_CROSS_BASE}/${py3_lib} -L${XBPS_CROSS_BASE}/usr/lib"
		CC="${XBPS_CROSS_TRIPLET}-gcc -pthread $CFLAGS $LDFLAGS"
		LDSHARED="${CC} -shared $LDFLAGS"
		for f in ${XBPS_CROSS_BASE}/${py3_lib}/_sysconfigdata_*; do
			f=${f##*/}
			_PYTHON_SYSCONFIGDATA_NAME=${f%.py}
		done
		env CC="$CC" LDSHARED="$LDSHARED" \
			PYPREFIX="$PYPREFIX" CFLAGS="$CFLAGS" \
			PYTHONPATH=${XBPS_CROSS_BASE}/${py3_lib} \
			_PYTHON_SYSCONFIGDATA_NAME="$_PYTHON_SYSCONFIGDATA_NAME" \
			LDFLAGS="$LDFLAGS" python3 setup.py \
				${@:-install --prefix=/usr --root=${DESTDIR}} ${make_install_args}
	else
		python3 setup.py ${@:-install --prefix=/usr --root=${DESTDIR}} ${make_install_args}
	fi
}

post_build() {
	# build ui
	_py build
}

do_install() {
	# rename bin daemon to opensnitchd
	for f in ${GOPATH}/bin/* ${GOPATH}/bin/**/*; do
	    if [ -f "$f" ] && [ -x "$f" ]; then
	        vbin "$f" opensnitchd
	        break
	    fi
	done

	vinstall "default-config.json" 644 "/etc/opensnitchd/"
	vinstall "system-fw.json" 644 "/etc/opensnitchd/"
	vsv opensnitchd

	#install ui
	_py
}
